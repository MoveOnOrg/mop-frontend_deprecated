# Share Links

After signing a petition, and some other places, there is an option to
share a link in many ways and mediums. The mop backend tracks how
links were shared and by whom, which helps track 'virality' and which
mediums/social-networks are being used for a particular petition (and petitions in general).

The links themselves follow several patterns, unfortunately, somewhat, complex.
This document is meant to explain and justify the different links and structures.

What we track:

* Medium/method of transmission -- was it email, facebook, twitter?
  Was it the petition creator or a signer?
* Who shared it -- who are the 'hubs' of sharing and how 'viral' is
  the petition?  Tracking the edges of the share-network for a particular
  petition help explain how a petition is popular.

## How we track shares in mop-frontend

### By source: ?source=

Many share urls contain a `source=` parameter, which has several
components separated by `.`s The first component is often either `s.`
or `c.` which indicates whether it was a link created by the petition
creator or a subsequent signer.  The following components often
indicate the medium (e.g. email vs. twitter, etc) and sometimes
something about the creator/signer -- e.g. if it was from a MoveOn
mailing or shared by a 'megapartner' organization.

Sources can also be simple strings like `topnav` or `dailykos` which
can be a particular link or organization.

### By user_id: ?r_by=

The oldest parameter that helps track share links from one signee to
another is `?r_by=` where the value is the user_id of the user who
shared the link.  If a user shares a petition and ?r_by= is on,
e.g. their facebook link, and then one of their friends signs the
petitions, and shares a link on the 'thanks' page, then the friend's
r_by= will be their own user_id, and thus all 'edges' in the social
graph can be mapped.

### By signature: ?r_hash=

Whereas our legacy system created a user_id upon signing a petition,
if one didn't exist, our new system defers that until later
processing.  That means there is no user_id to be added to an ?r_by=
parameter on the thanks page share links right after signing a
petition.

`r_hash=` is the solution to this issue.  Instead of tracking by user_id,
the signature submission returns an Amazon SQS json response, which
includes an md5 hash of the request body's submission data.  That md5
hash is also communicated with the signature data to the backend and processed.
We therefore process a portion of the md5sum in the same way on the frontend
and backend and when the frontend includes an ?r_hash parameter in a tracked
share link, by the time it's shared, the signature will have been processed
and we can match any r_hash value with the user information submitted with
the particular signature.

To see how r_hash is generated by the md5sum, see `src/lib/index.js::md5ToToken`

### By signature: /p/ shortcode urls

While ?source=, ?r_by= and ?r_hash= are useful query parameters that can be
attached to a full petition url, on mediums like Twitter where the aesthetic,
if not the medium itself, requires shorter urls, we want a short url that
achieves the same goals.  Urls of the form /p/c_abc_123abc and have two to three components.

* The first component maps to what is often communicated in the source= parameter--the
  medium and who shared the link (signer or creator).  It's case determines how
  to interpret the third component (see below).
* The second component maps to the petition id, which allows us to redirect to the petition
  from the shared link (arguably the most important part, so the link works!)
* The third component is either the user_id (if the user was logged in--corresponding to the
  r_by= value OR it corresponds to the r_hash= value.  If it's a r_hash value, then
  the first component is upper-cased

To see how the petition short-url is generated, see `src/lib/index.js::petitionShortCode`

### ShareBandit for Facebook links

In addition to the above links for email, twitter, and by-default facebook, some petitions
are marked to use our instance of [sharebandit](https://github.com/MoveOnOrg/sharebandit) to
create custom tracking links that have different treatments (title/image/description).
Currently, this is just for Facebook sharing -- in that case, the share link is calculated
uniquely for each visit with an API hit to the sharebandit
(see `src/actions/petitionsActions.js::getSharebanditShareLink` and the thanks container where it's called)
Then that link is used as the facebook share link.
